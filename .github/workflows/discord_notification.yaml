name: Discord Notification

on:
  push:
    branches:
      - '**'  # D√©clenche sur toutes les branches

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Extraire le nom du repository
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"  # Enl√®ve le owner/ pour garder juste le nom
          
          # Extraire le nom de la branche
          BRANCH_NAME="${{ github.ref }}"
          BRANCH_NAME="${BRANCH_NAME#refs/heads/}"
          
          # Informations du commit
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO_URL="${{ github.event.repository.html_url }}"
          
          # Timestamp actuel en format ISO 8601
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # √âchapper les caract√®res sp√©ciaux pour JSON
          COMMIT_MESSAGE_ESCAPED=$(echo "$COMMIT_MESSAGE" | jq -Rs .)
          
          # D√©terminer la couleur selon le repository
          case "$REPO_NAME" in
            *Mobile*|*mobile*)
              COLOR=10181046  # Violet
              ;;
            *CI-CD*|*ci-cd*|*CICD*|*cicd*)
              COLOR=3066993  # Vert d'eau/Cyan
              ;;
            *Web*|*web*)
              COLOR=5793266  # Bleu clair
              ;;
            *Resources*|*resources*)
              COLOR=9807270  # Rose/Magenta
              ;;
            *Backend*|*backend*)
              COLOR=3447003  # Bleu royal
              ;;
            *AI*|*ai*)
              COLOR=7506394  # Bleu-gris
              ;;
            *AR*|*ar*)
              COLOR=8359053  # Vert for√™t
              ;;
            *)
              COLOR=5763719  # Gris par d√©faut
              ;;
          esac
          
          # Cr√©er le payload JSON pour Discord
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "üì¶ Nouveau Push/Merge sur $REPO_NAME",
              "color": $COLOR,
              "fields": [
                {
                  "name": "üìÅ Repository",
                  "value": "**$REPO_NAME**",
                  "inline": true
                },
                {
                  "name": "üåø Branche",
                  "value": "\`$BRANCH_NAME\`",
                  "inline": true
                },
                {
                  "name": "üë§ Auteur",
                  "value": "$COMMIT_AUTHOR",
                  "inline": true
                },
                {
                  "name": "üí¨ Message du commit",
                  "value": $COMMIT_MESSAGE_ESCAPED,
                  "inline": false
                },
                {
                  "name": "üîñ Commit",
                  "value": "[\`$COMMIT_SHORT_SHA\`]($COMMIT_URL)",
                  "inline": true
                },
                {
                  "name": "üîó Repository",
                  "value": "[Voir le repo]($REPO_URL)",
                  "inline": true
                }
              ],
              "timestamp": "$TIMESTAMP",
              "footer": {
                "text": "GitHub Actions"
              }
            }]
          }
          EOF
          )
          
          # Envoyer la notification √† Discord
          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"